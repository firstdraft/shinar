<%= turbo_stream_from @chat %>

<% content_for :title, "#{@chat.subject} | Shinar" %>

<div class="d-flex align-items-center mb-3">
  <div>
    <%= link_to chats_path, class: "btn btn-outline-secondary rounded-circle d-flex justify-content-center align-items-center me-3", style: "width: 40px; height: 40px; padding: 0;" do %>
      <i class="fas fa-arrow-left"></i>
    <% end %>
  </div>
  <nav aria-label="breadcrumb" class="mb-0 fs-md-4 me-auto">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item"><a href="<%= chats_path %>">Chats</a></li>
      <li class="breadcrumb-item active" aria-current="page"><%= @chat.subject %></li>
    </ol>
  </nav>
  <div class="d-flex gap-2">
    <%= link_to edit_chat_path(@chat), class: "btn btn-outline-secondary rounded-circle d-flex justify-content-center align-items-center", style: "width: 40px; height: 40px; padding: 0;" do %>
      <i class="fa-regular fa-pen-to-square"></i>
    <% end %>

    <%= button_to @chat, method: :delete, class: "btn btn-outline-secondary rounded-circle d-flex justify-content-center align-items-center", style: "width: 40px; height: 40px; padding: 0;", form: { data: { turbo_confirm: "Are you sure?" } } do %>
      <i class="fa-regular fa-trash-can"></i>
    <% end %>
  </div>
</div>

<div class="row flex-grow-1 overflow-hidden">
  <!-- Mobile-first order: Chat members first on small screens -->
  <div class="col-md-4 col-lg-3 order-md-2 mb-md-0 d-flex flex-column">
    <div class="position-sticky h-100 d-flex flex-column" style="top: 0;">
      <!-- QR and Share buttons -->
      <div class="d-flex flex-column gap-3 mb-3">
        <%= link_to qr_chat_path(@chat), class: "btn btn-outline-success" do %>
          <i class="fas fa-qrcode me-1 fa-fw"></i> QR code
        <% end %>
        
        <button class="btn btn-outline-success" data-controller="clipboard" data-clipboard-target="button" data-action="click->clipboard#copy">
          <i class="fas fa-link me-1 fa-fw"></i> Copy link
        </button>
      </div>
      
      <!-- Chat members list -->
      <div class="list-group mb-0 flex-grow-1 overflow-auto">
        <div class="list-group-item text-center bg-light text-nowrap">
          Chat members (<%= @chat.chat_users_count %>)
        </div>
        <%= render partial: "chat_users/sidebar_user", collection: @chat_users, as: :chat_user %>
      </div>
    </div>
  </div>
  
  <!-- Chat messages second on mobile, first on larger screens -->
  <div class="col-md-8 col-lg-9 order-md-1 d-flex flex-column overflow-hidden">
    <div class="d-flex flex-column h-100 overflow-hidden">
      <!-- Message container with fixed form at bottom -->
      <div class="position-relative flex-grow-1 overflow-hidden">
        <!-- Message list with internal scrolling -->
        <div id="<%= dom_id(@chat, :message_list) %>" class="position-absolute top-0 start-0 bottom-0 end-0 overflow-auto" data-controller="chat">
          <div class="list-group mb-0">
            <% messages_by_day = @chat.messages.order(created_at: :asc).group_by_day(&:created_at) %>
            
            <% if messages_by_day.empty? %>
              <div class="list-group-item text-center bg-light text-nowrap">
                Today
              </div>
            <% else %>
              <% messages_by_day.each do |day, messages| %>
                <div class="list-group-item text-center bg-light text-nowrap">
                  <% if day == Date.today %>
                    Today
                  <% elsif day == Date.yesterday %>
                    Yesterday
                  <% else %>
                    <%= day.strftime("%A, %B %-d, %Y") %>
                  <% end %>
                </div>
                <%= render messages %>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Fixed new message form at bottom -->
      <div class="my-3">
        <%= render "messages/new_form", chat: @chat %>
      </div>
    </div>
  </div>
</div>
